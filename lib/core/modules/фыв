import 'package:flutter/material.dart';
import 'core/theme/app_theme.dart';
import 'core/modules/module.dart';

class EmployeesModule extends Module {
  EmployeesModule()
      : super(
          id: 'employees',
          title: 'Сотрудники',
          icon: Icons.people,
        );

  @override
  Widget build(BuildContext context) {
    return const _EmployeesPage();
  }
}

// ────────────────────────────────
// Внутренний экран сотрудников
// ────────────────────────────────

class _EmployeesPage extends StatefulWidget {
  const _EmployeesPage();

  @override
  State<_EmployeesPage> createState() => _EmployeesPageState();
}

class _EmployeesPageState extends State<_EmployeesPage> {
  final List<_Employee> _employees = _mockEmployees.toList();
  String _roleFilter = 'Все роли';
  String _branchFilter = 'Все филиалы';
  String _query = '';

  @override
  Widget build(BuildContext context) {
    final filtered = _employees.where((e) {
      final matchesRole = _roleFilter == 'Все роли' || e.role == _roleFilter;
      final matchesBranch =
          _branchFilter == 'Все филиалы' || e.branch == _branchFilter;
      final matchesQuery = _query.isEmpty ||
          e.name.toLowerCase().contains(_query.toLowerCase()) ||
          e.email.toLowerCase().contains(_query.toLowerCase());
      return matchesRole && matchesBranch && matchesQuery;
    }).toList();

    return Scaffold(
      backgroundColor: vgSurface,
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Заголовок и кнопка "Добавить"
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    'Сотрудники',
                    style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                          color: vgTextMain,
                          fontWeight: FontWeight.bold,
                        ),
                  ),
                  ElevatedButton.icon(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: vgPrimary,
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    onPressed: _addEmployee,
                    icon: const Icon(Icons.add),
                    label: const Text('Добавить'),
                  ),
                ],
              ),
              const SizedBox(height: 20),

              // Фильтры
              Wrap(
                spacing: 12,
                runSpacing: 8,
                children: [
                  _buildDropdown(
                    label: 'Роль',
                    value: _roleFilter,
                    items: _roles,
                    onChanged: (v) => setState(() => _roleFilter = v!),
                  ),
                  _buildDropdown(
                    label: 'Филиал',
                    value: _branchFilter,
                    items: _branches,
                    onChanged: (v) => setState(() => _branchFilter = v!),
                  ),
                  _buildSearchField(),
                ],
              ),
              const SizedBox(height: 20),

              // Таблица сотрудников
              Expanded(
                child: Container(
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(16),
                    boxShadow: const [
                      BoxShadow(
                        color: Color(0x1A000000),
                        blurRadius: 12,
                        offset: Offset(0, 6),
                      ),
                    ],
                  ),
                  child: SingleChildScrollView(
                    scrollDirection: Axis.horizontal,
                    child: DataTable(
                      headingTextStyle: const TextStyle(
                        fontWeight: FontWeight.w600,
                        color: vgTextMain,
                      ),
                      columns: const [
                        DataColumn(label: Text('Имя')),
                        DataColumn(label: Text('Роль')),
                        DataColumn(label: Text('Филиал')),
                        DataColumn(label: Text('Email')),
                        DataColumn(label: Text('Телефон')),
                        DataColumn(label: Text('Статус')),
                        DataColumn(label: Text('Действия')),
                      ],
                      rows: filtered.map((e) {
                        return DataRow(
                          cells: [
                            DataCell(Text(e.name)),
                            DataCell(Text(e.role)),
                            DataCell(Text(e.branch)),
                            DataCell(Text(e.email)),
                            DataCell(Text(e.phone)),
                            DataCell(Row(
                              children: [
                                Icon(
                                  Icons.circle,
                                  size: 10,
                                  color: e.isActive
                                      ? Colors.green
                                      : Colors.grey,
                                ),
                                const SizedBox(width: 6),
                                Text(e.isActive ? 'Активен' : 'Архив'),
                              ],
                            )),
                            DataCell(Row(
                              children: [
                                IconButton(
                                  tooltip: 'Редактировать',
                                  icon: const Icon(Icons.edit),
                                  color: vgTextMain,
                                  onPressed: () => _editEmployee(e),
                                ),
                                IconButton(
                                  tooltip: 'Удалить',
                                  icon: const Icon(Icons.delete_outline),
                                  color: vgPrimary,
                                  onPressed: () => _deleteEmployee(e),
                                ),
                              ],
                            )),
                          ],
                        );
                      }).toList(),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // ──────────── Виджеты фильтров ────────────

  Widget _buildDropdown({
    required String label,
    required String value,
    required List<String> items,
    required ValueChanged<String?> onChanged,
  }) {
    return SizedBox(
      width: 200,
      child: DropdownButtonFormField<String>(
        value: value,
        items: items
            .map((e) => DropdownMenuItem(value: e, child: Text(e)))
            .toList(),
        onChanged: onChanged,
        decoration: InputDecoration(
          labelText: label,
          filled: true,
          fillColor: Colors.white,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide.none,
          ),
          contentPadding:
              const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
        ),
      ),
    );
  }

  Widget _buildSearchField() {
    return SizedBox(
      width: 250,
      child: TextField(
        onChanged: (v) => setState(() => _query = v),
        decoration: InputDecoration(
          prefixIcon: const Icon(Icons.search),
          hintText: 'Поиск сотрудника…',
          filled: true,
          fillColor: Colors.white,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide.none,
          ),
          contentPadding:
              const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
        ),
      ),
    );
  }

  // ──────────── Действия ────────────

  void _addEmployee() async {
    final result = await showDialog<_Employee>(
      context: context,
      builder: (_) => const _EmployeeDialog(),
    );
    if (result != null) {
      setState(() => _employees.add(result));
    }
  }

  void _editEmployee(_Employee e) async {
    final result = await showDialog<_Employee>(
      context: context,
      builder: (_) => _EmployeeDialog(initial: e),
    );
    if (result != null) {
      setState(() {
        final i = _employees.indexWhere((x) => x.id == e.id);
        if (i != -1) _employees[i] = result;
      });
    }
  }

  void _deleteEmployee(_Employee e) {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text('Удаление'),
        content: Text('Удалить сотрудника ${e.name}?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Отмена'),
          ),
          TextButton(
            onPressed: () {
              setState(() => _employees.remove(e));
              Navigator.pop(context);
            },
            child: const Text('Удалить', style: TextStyle(color: vgPrimary)),
          ),
        ],
      ),
    );
  }
}

// ────────────────────────────────
// Диалог добавления / редактирования
// ────────────────────────────────

class _EmployeeDialog extends StatefulWidget {
  final _Employee? initial;

  const _EmployeeDialog({this.initial});

  @override
  State<_EmployeeDialog> createState() => _EmployeeDialogState();
}

class _EmployeeDialogState extends State<_EmployeeDialog> {
  final _formKey = GlobalKey<FormState>();

  late TextEditingController _name;
  late TextEditingController _email;
  late TextEditingController _phone;
  String _role = 'Менеджер';
  String _branch = 'Бутово';
  bool _isActive = true;

  @override
  void initState() {
    super.initState();
    final i = widget.initial;
    _name = TextEditingController(text: i?.name ?? '');
    _email = TextEditingController(text: i?.email ?? '');
    _phone = TextEditingController(text: i?.phone ?? '');
    _role = i?.role ?? 'Менеджер';
    _branch = i?.branch ?? 'Бутово';
    _isActive = i?.isActive ?? true;
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.white,
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: ConstrainedBox(
          constraints: const BoxConstraints(maxWidth: 500),
          child: Form(
            key: _formKey,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  widget.initial == null
                      ? 'Добавить сотрудника'
                      : 'Редактировать сотрудника',
                  style: const TextStyle(
                    fontWeight: FontWeight.bold,
                    fontSize: 18,
                    color: vgTextMain,
                  ),
                ),
                const SizedBox(height: 16),
                TextFormField(
                  controller: _name,
                  decoration: const InputDecoration(labelText: 'Имя и фамилия'),
                  validator: (v) =>
                      (v == null || v.isEmpty) ? 'Введите имя' : null,
                ),
                const SizedBox(height: 12),
                TextFormField(
                  controller: _email,
                  decoration: const InputDecoration(labelText: 'Email'),
                  validator: (v) {
                    if (v == null || v.isEmpty) return 'Введите email';
                    if (!v.contains('@')) return 'Некорректный email';
                    return null;
                  },
                ),
                const SizedBox(height: 12),
                TextFormField(
                  controller: _phone,
                  decoration: const InputDecoration(labelText: 'Телефон'),
                  validator: (v) =>
                      (v == null || v.isEmpty) ? 'Введите телефон' : null,
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Expanded(
                      child: DropdownButtonFormField<String>(
                        value: _role,
                        items: _roles
                            .where((e) => e != 'Все роли')
                            .map((e) =>
                                DropdownMenuItem(value: e, child: Text(e)))
                            .toList(),
                        onChanged: (v) => setState(() => _role = v!),
                        decoration: const InputDecoration(labelText: 'Роль'),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: DropdownButtonFormField<String>(
                        value: _branch,
                        items: _branches
                            .where((e) => e != 'Все филиалы')
                            .map((e) =>
                                DropdownMenuItem(value: e, child: Text(e)))
                            .toList(),
                        onChanged: (v) => setState(() => _branch = v!),
                        decoration: const InputDecoration(labelText: 'Филиал'),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                SwitchListTile(
                  title: const Text('Активен'),
                  value: _isActive,
                  onChanged: (v) => setState(() => _isActive = v),
                  contentPadding: EdgeInsets.zero,
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Expanded(
                      child: OutlinedButton(
                        onPressed: () => Navigator.pop(context),
                        child: const Text('Отмена'),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: vgPrimary,
                          foregroundColor: Colors.white,
                        ),
                        onPressed: () {
                          if (_formKey.currentState!.validate()) {
                            Navigator.pop(
                              context,
                              _Employee(
                                id: widget.initial?.id ??
                                    DateTime.now()
                                        .millisecondsSinceEpoch
                                        .toString(),
                                name: _name.text,
                                role: _role,
                                branch: _branch,
                                email: _email.text,
                                phone: _phone.text,
                                isActive: _isActive,
                              ),
                            );
                          }
                        },
                        child: const Text('Сохранить'),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// ────────────────────────────────
// Модель данных
// ────────────────────────────────

class _Employee {
  final String id;
  final String name;
  final String role;
  final String branch;
  final String email;
  final String phone;
  final bool isActive;

  _Employee({
    required this.id,
    required this.name,
    required this.role,
    required this.branch,
    required this.email,
    required this.phone,
    required this.isActive,
  });
}

// ────────────────────────────────
// Тестовые данные
// ────────────────────────────────

const _roles = ['Все роли', 'Оператор', 'Менеджер', 'Администратор', 'Управляющий'];
const _branches = ['Все филиалы', 'Охотный ряд', 'Римская', 'Бутово', 'Химки 2а', 'Химки 3а'];

final _mockEmployees = [
  _Employee(
    id: '1',
    name: 'Иван Иванов',
    role: 'Менеджер',
    branch: 'Бутово',
    email: 'ivanov@vgcrm.ru',
    phone: '+7 999 111-11-11',
    isActive: true,
  ),
  _Employee(
    id: '2',
    name: 'Мария Петрова',
    role: 'Оператор',
    branch: 'Охотный ряд',
    email: 'petrova@vgcrm.ru',
    phone: '+7 999 222-22-22',
    isActive: true,
  ),
  _Employee(
    id: '3',
    name: 'Ольга Кузнецова',
    role: 'Управляющий',
    branch: 'Римская',
    email: 'kuznetsova@vgcrm.ru',
    phone: '+7 999 333-33-33',
    isActive: false,
  ),
];
